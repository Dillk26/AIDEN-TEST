<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systems of Equations Test (30 Questions - All Solvable)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Calculator = ({ size = 24, className }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/>
            </svg>
        );
        const CheckCircle = ({ size = 24, className }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );
        const XCircle = ({ size = 24, className }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>
            </svg>
        );
        const ArrowRight = ({ size = 24, className }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M5 12h14"/><path d="m12 5 7 7-7 7"/>
            </svg>
        );
        const RefreshCw = ({ size = 24, className }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>
            </svg>
        );
        const PenTool = ({ size = 24, className }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/>
            </svg>
        );

        /**
         * UTILITIES & PARSING
         */
        const parseNumber = (input) => {
            if (typeof input === 'number') return input;
            if (!input) return NaN;
            const str = input.trim();
            if (str.includes('/')) {
                const [num, den] = str.split('/');
                return parseFloat(num) / parseFloat(den);
            }
            return parseFloat(str);
        };

        const isClose = (a, b, epsilon = 0.1) => Math.abs(a - b) < epsilon;

        /**
         * DATA: QUESTIONS (30 - No Infinite/No Solution cases)
         */
        const QUESTIONS = [
            // --- ORIGINAL QUESTIONS (1-13) ---
            {
                id: 1,
                type: 'substitution',
                title: 'Solving by Substitution',
                instruction: 'Solve the system using substitution.',
                equations: ['y = 3x - 2', 'y = x + 6'],
                inputs: [{ label: 'x', answer: 4 }, { label: 'y', answer: 10 }],
                explanation: (
                    <div className="space-y-2">
                        <p><strong>Step 1: Set equations equal.</strong> 3x - 2 = x + 6</p>
                        <p><strong>Step 2: Solve for x.</strong> 2x = 8 → x = 4</p>
                        <p><strong>Step 3: Solve for y.</strong> y = 4 + 6 = 10</p>
                        <p className="font-bold text-green-700">Solution: (4, 10)</p>
                    </div>
                )
            },
            {
                id: 2,
                type: 'substitution',
                title: 'Solving by Substitution',
                instruction: 'Solve the system using substitution.',
                equations: ['y = -2x + 5', '4x + y = 7'],
                inputs: [{ label: 'x', answer: 1 }, { label: 'y', answer: 3 }],
                explanation: (
                    <div className="space-y-2">
                        <p><strong>Step 1: Substitute y.</strong> 4x + (-2x + 5) = 7</p>
                        <p><strong>Step 2: Solve for x.</strong> 2x + 5 = 7 → 2x = 2 → x = 1</p>
                        <p><strong>Step 3: Solve for y.</strong> y = -2(1) + 5 = 3</p>
                        <p className="font-bold text-green-700">Solution: (1, 3)</p>
                    </div>
                )
            },
            // CHANGED (Was No Solution)
            {
                id: 3,
                type: 'elimination',
                title: 'Solving by Elimination',
                instruction: 'Solve the system using elimination.',
                equations: ['3x + 2y = 10', '3x - 2y = 2'],
                inputs: [{ label: 'x', answer: 2 }, { label: 'y', answer: 2 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Add equations: (3x+3x) + (2y-2y) = 10+2</p>
                        <p>6x = 12 → x = 2</p>
                        <p>Substitute x=2: 3(2) + 2y = 10 → 6 + 2y = 10 → 2y = 4 → y = 2</p>
                        <p className="font-bold text-green-700">Solution: (2, 2)</p>
                    </div>
                )
            },
            {
                id: 4,
                type: 'elimination',
                title: 'Solving by Elimination',
                instruction: 'Solve using elimination. (Fractions allowed)',
                equations: ['4x - y = 9', '2x + y = 7'],
                inputs: [{ label: 'x', answer: 8/3 }, { label: 'y', answer: 5/3 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Add equations: 6x = 16 → x = 16/6 = 8/3</p>
                        <p>Substitute x: 2(8/3) + y = 7 → 16/3 + y = 21/3</p>
                        <p>y = 5/3</p>
                        <p className="font-bold text-green-700">Solution: (8/3, 5/3)</p>
                    </div>
                )
            },
            {
                id: 5,
                type: 'graphing',
                title: 'Solving by Graphing',
                instruction: 'Graph both lines.',
                equations: ['y = x - 1', 'y = -2x + 5'],
                targetLines: [{ m: 1, b: -1 }, { m: -2, b: 5 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Line 1: Start at -1, Slope 1.</p>
                        <p>Line 2: Start at 5, Slope -2.</p>
                        <p>Intersection: (2, 1)</p>
                    </div>
                )
            },
            // CHANGED (Was No Solution)
            {
                id: 6,
                type: 'graphing',
                title: 'Solving by Graphing',
                instruction: 'Graph both lines.',
                equations: ['y = x + 2', 'y = -x + 4'],
                targetLines: [{ m: 1, b: 2 }, { m: -1, b: 4 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Line 1: Start at 2, slope 1 (Up 1, Right 1).</p>
                        <p>Line 2: Start at 4, slope -1 (Down 1, Right 1).</p>
                        <p>Intersect at (1, 3).</p>
                        <p className="font-bold text-green-700">Solution: (1, 3)</p>
                    </div>
                )
            },
            {
                id: 7,
                type: 'mixed',
                title: 'Elimination Method',
                instruction: 'Solve using Elimination.',
                equations: ['3x + 2y = 12', '6x - 2y = 8'],
                inputs: [{ label: 'x', answer: 20/9 }, { label: 'y', answer: 8/3 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Add equations: 9x = 20 → x = 20/9</p>
                        <p>Substitute: 3(20/9) + 2y = 12 → 20/3 + 2y = 36/3</p>
                        <p>2y = 16/3 → y = 8/3</p>
                    </div>
                )
            },
            {
                id: 8,
                type: 'mixed',
                title: 'Substitution Method',
                instruction: 'Solve using Substitution.',
                equations: ['y = -x + 7', '2x + y = 9'],
                inputs: [{ label: 'x', answer: 2 }, { label: 'y', answer: 5 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Sub y: 2x + (-x + 7) = 9</p>
                        <p>x + 7 = 9 → x = 2</p>
                        <p>y = -2 + 7 = 5</p>
                    </div>
                )
            },
            {
                id: 9,
                type: 'word',
                title: 'Theater Tickets',
                instruction: 'Adult $12, Student $8. 95 sold, $940 total.',
                inputs: [{ label: 'Adult', answer: 45 }, { label: 'Student', answer: 50 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Eq 1: a + s = 95</p>
                        <p>Eq 2: 12a + 8s = 940</p>
                        <p>Solve: a = 45, s = 50</p>
                    </div>
                )
            },
            {
                id: 10,
                type: 'word',
                title: 'Cell Phone Plans',
                instruction: 'Plan A: $30 + $5/GB. Plan B: $20 + $7/GB. Find equal cost GB.',
                inputs: [{ label: 'GB', answer: 5 }],
                explanation: (
                    <div className="space-y-2">
                        <p>30 + 5x = 20 + 7x</p>
                        <p>10 = 2x → x = 5</p>
                    </div>
                )
            },
            {
                id: 11,
                type: 'word',
                title: 'School Play',
                instruction: 'Adult $10, Child $6. 120 sold, $960 total.',
                inputs: [{ label: 'Adult', answer: 60 }, { label: 'Child', answer: 60 }],
                explanation: (
                    <div className="space-y-2">
                        <p>10a + 6c = 960 and a + c = 120</p>
                        <p>Solve: a = 60, c = 60</p>
                    </div>
                )
            },
            {
                id: 12,
                type: 'word',
                title: 'Rectangle Geometry',
                instruction: 'Perimeter 56. Length is 3 times Width.',
                inputs: [{ label: 'Area', answer: 147 }],
                explanation: (
                    <div className="space-y-2">
                        <p>2L + 2W = 56 and L = 3W</p>
                        <p>2(3W) + 2W = 56 → 8W = 56 → W = 7</p>
                        <p>L = 21. Area = 147.</p>
                    </div>
                )
            },
            {
                id: 13,
                type: 'graphing',
                title: 'Inequalities',
                instruction: 'Graph lines for: y >= -x + 2 and y < 2x - 1',
                equations: ['y >= -x + 2', 'y < 2x - 1'],
                targetLines: [{ m: -1, b: 2 }, { m: 2, b: -1 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Line 1: y = -x + 2 (Solid, Shade Up)</p>
                        <p>Line 2: y = 2x - 1 (Dashed, Shade Down)</p>
                    </div>
                )
            },
            // --- NEW QUESTIONS (14-30) ---
            {
                id: 14,
                type: 'substitution',
                title: 'Substitution Practice',
                instruction: 'Solve the system.',
                equations: ['y = 4x', 'x + y = 5'],
                inputs: [{ label: 'x', answer: 1 }, { label: 'y', answer: 4 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Sub y=4x into x+y=5: x + 4x = 5</p>
                        <p>5x = 5 → x = 1</p>
                        <p>y = 4(1) = 4</p>
                        <p className="font-bold text-green-700">Solution: (1, 4)</p>
                    </div>
                )
            },
            {
                id: 15,
                type: 'substitution',
                title: 'Substitution with Negative',
                instruction: 'Solve the system.',
                equations: ['x = -2y', 'x - y = 9'],
                inputs: [{ label: 'x', answer: 6 }, { label: 'y', answer: -3 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Sub x=-2y into x-y=9: (-2y) - y = 9</p>
                        <p>-3y = 9 → y = -3</p>
                        <p>x = -2(-3) = 6</p>
                        <p className="font-bold text-green-700">Solution: (6, -3)</p>
                    </div>
                )
            },
            // CHANGED (Was No Solution)
            {
                id: 16,
                type: 'substitution',
                title: 'Substitution Practice',
                instruction: 'Solve the system.',
                equations: ['y = 2x', 'y = x + 3'],
                inputs: [{ label: 'x', answer: 3 }, { label: 'y', answer: 6 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Set equal: 2x = x + 3</p>
                        <p>Subtract x: x = 3</p>
                        <p>y = 2(3) = 6</p>
                        <p className="font-bold text-green-700">Solution: (3, 6)</p>
                    </div>
                )
            },
            {
                id: 17,
                type: 'elimination',
                title: 'Basic Elimination',
                instruction: 'Solve the system.',
                equations: ['x + y = 10', 'x - y = 4'],
                inputs: [{ label: 'x', answer: 7 }, { label: 'y', answer: 3 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Add equations: (x+x) + (y-y) = 10+4</p>
                        <p>2x = 14 → x = 7</p>
                        <p>7 + y = 10 → y = 3</p>
                    </div>
                )
            },
            {
                id: 18,
                type: 'elimination',
                title: 'Elimination with Multipliers',
                instruction: 'Solve using elimination.',
                equations: ['2x + y = 12', '-2x + 3y = 4'],
                inputs: [{ label: 'x', answer: 4 }, { label: 'y', answer: 4 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Add equations: (2x - 2x) + (y + 3y) = 12 + 4</p>
                        <p>4y = 16 → y = 4</p>
                        <p>2x + 4 = 12 → 2x = 8 → x = 4</p>
                    </div>
                )
            },
            {
                id: 19,
                type: 'elimination',
                title: 'Elimination Practice',
                instruction: 'Solve the system.',
                equations: ['3x + 4y = 10', '2x - 4y = 0'],
                inputs: [{ label: 'x', answer: 2 }, { label: 'y', answer: 1 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Add equations: 5x = 10 → x = 2</p>
                        <p>2(2) - 4y = 0 → 4 = 4y → y = 1</p>
                    </div>
                )
            },
            {
                id: 20,
                type: 'graphing',
                title: 'Graphing Intersection',
                instruction: 'Graph both lines.',
                equations: ['y = x', 'y = -x + 4'],
                targetLines: [{ m: 1, b: 0 }, { m: -1, b: 4 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Line 1: y = x (Starts at 0, slope 1)</p>
                        <p>Line 2: y = -x + 4 (Starts at 4, slope -1)</p>
                        <p>Intersect at (2, 2)</p>
                    </div>
                )
            },
            // CHANGED (Was No Solution)
            {
                id: 21,
                type: 'graphing',
                title: 'Graphing Practice',
                instruction: 'Graph both lines.',
                equations: ['y = 2x - 3', 'y = -x + 3'],
                targetLines: [{ m: 2, b: -3 }, { m: -1, b: 3 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Line 1: y = 2x - 3 (Start -3, Up 2 Right 1).</p>
                        <p>Line 2: y = -x + 3 (Start 3, Down 1 Right 1).</p>
                        <p>Intersect at (2, 1).</p>
                        <p className="font-bold text-green-700">Solution: (2, 1)</p>
                    </div>
                )
            },
            {
                id: 22,
                type: 'graphing',
                title: 'Horizontal & Vertical Lines',
                instruction: 'Graph the lines x = 3 and y = 2.',
                equations: ['x = 3', 'y = 2'],
                targetLines: [{ isVertical: true, x: 3 }, { m: 0, b: 2 }],
                explanation: (
                    <div className="space-y-2">
                        <p>x = 3 is a vertical line at x=3.</p>
                        <p>y = 2 is a horizontal line at y=2.</p>
                        <p>They intersect at (3, 2).</p>
                    </div>
                )
            },
            {
                id: 23,
                type: 'graphing',
                title: 'Graphing Practice',
                instruction: 'Graph both lines.',
                equations: ['y = 2x', 'y = x - 1'],
                targetLines: [{ m: 2, b: 0 }, { m: 1, b: -1 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Line 1: y = 2x (Origin, up 2 right 1)</p>
                        <p>Line 2: y = x - 1</p>
                        <p>Intersect at (-1, -2)</p>
                    </div>
                )
            },
            {
                id: 24,
                type: 'word',
                title: 'Number Problem',
                instruction: 'The sum of two numbers is 25. Their difference is 5. Find the numbers.',
                inputs: [{ label: 'Larger Number', answer: 15 }, { label: 'Smaller Number', answer: 10 }],
                explanation: (
                    <div className="space-y-2">
                        <p>x + y = 25</p>
                        <p>x - y = 5</p>
                        <p>Add: 2x = 30 → x = 15. y = 10.</p>
                    </div>
                )
            },
            {
                id: 25,
                type: 'word',
                title: 'Concession Stand',
                instruction: '3 sodas and 2 popcorns cost $19. 2 sodas and 2 popcorns cost $16. Find cost of soda.',
                inputs: [{ label: 'Soda Cost ($)', answer: 3 }],
                explanation: (
                    <div className="space-y-2">
                        <p>3s + 2p = 19</p>
                        <p>2s + 2p = 16</p>
                        <p>Subtract: s = 3</p>
                        <p>Soda costs $3.</p>
                    </div>
                )
            },
            {
                id: 26,
                type: 'word',
                title: 'Perimeter Problem',
                instruction: 'Rectangle perimeter is 20. Length is 2 more than Width. Find Area.',
                inputs: [{ label: 'Area', answer: 24 }],
                explanation: (
                    <div className="space-y-2">
                        <p>2L + 2W = 20 → L + W = 10</p>
                        <p>L = W + 2</p>
                        <p>(W+2) + W = 10 → 2W = 8 → W = 4, L = 6</p>
                        <p>Area = 6 × 4 = 24</p>
                    </div>
                )
            },
            {
                id: 27,
                type: 'word',
                title: 'Coin Problem',
                instruction: '10 coins (Quarters and Dimes). Total value $1.90. How many Quarters?',
                inputs: [{ label: 'Quarters', answer: 6 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Q + D = 10 → D = 10 - Q</p>
                        <p>0.25Q + 0.10D = 1.90</p>
                        <p>0.25Q + 0.10(10 - Q) = 1.90</p>
                        <p>0.25Q + 1 - 0.10Q = 1.90</p>
                        <p>0.15Q = 0.90 → Q = 6</p>
                    </div>
                )
            },
            {
                id: 28,
                type: 'graphing',
                title: 'Inequalities Region',
                instruction: 'Graph lines for: y > x - 2 and y < -x + 2',
                equations: ['y > x - 2', 'y < -x + 2'],
                targetLines: [{ m: 1, b: -2 }, { m: -1, b: 2 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Line 1: y = x - 2 (Dashed, Shade Above)</p>
                        <p>Line 2: y = -x + 2 (Dashed, Shade Below)</p>
                        <p>Solution is the region between lines.</p>
                    </div>
                )
            },
            {
                id: 29,
                type: 'graphing',
                title: 'System with Vertical Bound',
                instruction: 'Graph lines for: y = 3 and x = 2.',
                equations: ['y >= 3', 'x < 2'],
                targetLines: [{ m: 0, b: 3 }, { isVertical: true, x: 2 }],
                explanation: (
                    <div className="space-y-2">
                        <p>y = 3 is Horizontal.</p>
                        <p>x = 2 is Vertical.</p>
                        <p>Region: Above y=3 and Left of x=2.</p>
                    </div>
                )
            },
            // CHANGED (Was Infinite)
            {
                id: 30,
                type: 'mixed',
                title: 'Mixed Practice',
                instruction: 'Solve the system.',
                equations: ['2x + y = 8', 'y = x + 2'],
                inputs: [{ label: 'x', answer: 2 }, { label: 'y', answer: 4 }],
                explanation: (
                    <div className="space-y-2">
                        <p>Sub y=x+2 into 2x+y=8: 2x + (x+2) = 8</p>
                        <p>3x = 6 → x = 2</p>
                        <p>y = 2 + 2 = 4</p>
                        <p className="font-bold text-green-700">Solution: (2, 4)</p>
                    </div>
                )
            }
        ];

        /**
         * COMPONENT: INTERACTIVE GRAPH
         */
        const InteractiveGraph = ({ onLinesUpdate, isReadOnly, resetTrigger }) => {
            const canvasRef = useRef(null);
            const [points, setPoints] = useState([]);
            
            useEffect(() => {
                setPoints([]);
            }, [resetTrigger]);

            const gridSize = 20; 
            const width = 400;
            const height = 400;
            const centerX = width / 2;
            const centerY = height / 2;

            const toGrid = (px, py) => {
                const x = Math.round((px - centerX) / gridSize);
                const y = Math.round(-(py - centerY) / gridSize);
                return { x, y };
            };

            const toScreen = (gx, gy) => {
                return {
                    x: centerX + gx * gridSize,
                    y: centerY - gy * gridSize
                };
            };

            const draw = (ctx) => {
                ctx.fillStyle = '#f9fafb';
                ctx.fillRect(0, 0, width, height);

                ctx.beginPath();
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i <= width; i += gridSize) {
                    ctx.moveTo(i, 0); ctx.lineTo(i, height);
                    ctx.moveTo(0, i); ctx.lineTo(width, i);
                }
                ctx.stroke();

                ctx.beginPath();
                ctx.strokeStyle = '#374151';
                ctx.lineWidth = 2;
                ctx.moveTo(centerX, 0); ctx.lineTo(centerX, height);
                ctx.moveTo(0, centerY); ctx.lineTo(width, centerY);
                ctx.stroke();

                points.forEach((p, idx) => {
                    const screen = toScreen(p.x, p.y);
                    ctx.beginPath();
                    ctx.fillStyle = idx < 2 ? '#2563eb' : '#dc2626';
                    ctx.arc(screen.x, screen.y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });

                const drawLineFromPoints = (p1, p2, color) => {
                    if (!p1 || !p2) return;
                    
                    const s1 = toScreen(p1.x, p1.y);
                    const slope = (p2.y - p1.y) / (p2.x - p1.x);
                    
                    ctx.beginPath();
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;

                    if (!isFinite(slope)) {
                        ctx.moveTo(s1.x, 0);
                        ctx.lineTo(s1.x, height);
                    } else {
                        const b = p1.y - slope * p1.x;
                        const leftX = -15; 
                        const leftY = slope * leftX + b;
                        const rightX = 15;
                        const rightY = slope * rightX + b;
                        const start = toScreen(leftX, leftY);
                        const end = toScreen(rightX, rightY);
                        ctx.moveTo(start.x, start.y);
                        ctx.lineTo(end.x, end.y);
                    }
                    ctx.stroke();
                };

                if (points.length >= 2) drawLineFromPoints(points[0], points[1], '#2563eb');
                if (points.length >= 4) drawLineFromPoints(points[2], points[3], '#dc2626');

                if (!isReadOnly && onLinesUpdate) {
                    const lines = [];
                    const processLine = (pA, pB) => {
                         const m = (pB.y - pA.y) / (pB.x - pA.x);
                         const b = pA.y - m * pA.x;
                         return { m, b, isVertical: !isFinite(m), xInt: pA.x };
                    };
                    if (points.length >= 2) lines.push(processLine(points[0], points[1]));
                    if (points.length >= 4) lines.push(processLine(points[2], points[3]));
                    onLinesUpdate(lines);
                }
            };

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                draw(ctx);
            }, [points]);

            const handleClick = (e) => {
                if (isReadOnly || points.length >= 4) return;
                const rect = canvasRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const gridP = toGrid(x, y);
                setPoints([...points, gridP]);
            };

            return (
                <div className="flex flex-col items-center">
                    <canvas 
                        ref={canvasRef} 
                        width={width} 
                        height={height} 
                        onClick={handleClick}
                        className="border border-gray-300 rounded shadow-sm cursor-crosshair bg-white"
                    />
                    <div className="mt-2 text-sm text-gray-500">
                        {points.length < 4 ? "Click to plot points" : "Graph complete. Submit answer."}
                    </div>
                </div>
            );
        };

        /**
         * MAIN COMPONENT
         */
        const SystemsTest = () => {
            const [currentIdx, setCurrentIdx] = useState(0);
            const [userInputs, setUserInputs] = useState({});
            const [graphLines, setGraphLines] = useState([]);
            const [showExplanation, setShowExplanation] = useState(false);
            const [isCorrect, setIsCorrect] = useState(false);
            const [score, setScore] = useState(0);
            const [isFinished, setIsFinished] = useState(false);
            const [graphResetCounter, setGraphResetCounter] = useState(0);

            const question = QUESTIONS[currentIdx];

            const handleInputChange = (idx, value) => {
                setUserInputs(prev => ({ ...prev, [idx]: value }));
            };

            const checkAnswer = () => {
                let correct = true;

                if (question.type === 'graphing') {
                    if (graphLines.length < 2) {
                        correct = false;
                    } else {
                        const match = (u, t) => {
                            if (t.isVertical) {
                                return u.isVertical && isClose(u.xInt, t.x);
                            }
                            return !u.isVertical && isClose(u.m, t.m) && isClose(u.b, t.b);
                        };
                        
                        const t1 = question.targetLines[0];
                        const t2 = question.targetLines[1];
                        const u1 = graphLines[0];
                        const u2 = graphLines[1];

                        const perm1 = match(u1, t1) && match(u2, t2);
                        const perm2 = match(u1, t2) && match(u2, t1);

                        correct = perm1 || perm2;
                    }
                } else {
                    question.inputs.forEach((input, idx) => {
                        const userVal = userInputs[idx];
                        if (input.isText) {
                            if (!userVal || userVal.toLowerCase() !== input.answer) correct = false;
                        } else {
                            const valNum = parseNumber(userVal);
                            if (isNaN(valNum) || !isClose(valNum, input.answer)) correct = false;
                        }
                    });
                }

                setIsCorrect(correct);
                if (correct) setScore(s => s + 1);
                setShowExplanation(true);
            };

            const nextQuestion = () => {
                if (currentIdx < QUESTIONS.length - 1) {
                    setCurrentIdx(c => c + 1);
                    setUserInputs({});
                    setGraphLines([]);
                    setGraphResetCounter(c => c + 1);
                    setShowExplanation(false);
                    setIsCorrect(false);
                } else {
                    setIsFinished(true);
                }
            };

            const resetTest = () => {
                setCurrentIdx(0);
                setScore(0);
                setIsFinished(false);
                setShowExplanation(false);
                setUserInputs({});
                setGraphLines([]);
                setGraphResetCounter(c => c + 1);
            };

            if (isFinished) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans">
                        <div className="bg-white p-8 rounded-lg shadow-lg max-w-md w-full text-center">
                            <CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
                            <h2 className="text-2xl font-bold mb-2">Test Complete!</h2>
                            <p className="text-gray-600 mb-6">You scored {score} out of {QUESTIONS.length}</p>
                            <div className="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                                <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${(score / QUESTIONS.length) * 100}%` }}></div>
                            </div>
                            <button onClick={resetTest} className="flex items-center justify-center gap-2 w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition">
                                <RefreshCw size={18} /> Retry Test
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8 font-sans">
                    <div className="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="bg-blue-600 p-6 text-white flex justify-between items-center">
                            <div>
                                <h1 className="text-xl md:text-2xl font-bold flex items-center gap-2">
                                    <Calculator size={24} /> Systems Test
                                </h1>
                                <p className="text-blue-100 text-sm mt-1">Question {currentIdx + 1} of {QUESTIONS.length}</p>
                            </div>
                            <div className="text-2xl font-bold opacity-80">{score} pts</div>
                        </div>

                        <div className="p-6 md:p-8">
                            <div className="mb-6">
                                <span className="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded uppercase tracking-wide">
                                    {question.type}
                                </span>
                                <h2 className="text-xl font-bold text-gray-800 mt-2">{question.title}</h2>
                                <p className="text-gray-600 mt-2">{question.instruction}</p>
                                
                                <div className="mt-4 p-4 bg-gray-100 rounded-lg border border-gray-200 inline-block pr-12">
                                    {question.equations && question.equations.map((eq, i) => (
                                        <div key={i} className="font-mono text-lg text-gray-800 mb-1 last:mb-0">
                                            {i + 1}) {eq}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {!showExplanation && (
                                <div className="space-y-6">
                                    {question.type === 'graphing' ? (
                                        <div className="space-y-4">
                                            <InteractiveGraph 
                                                onLinesUpdate={setGraphLines} 
                                                resetTrigger={graphResetCounter}
                                            />
                                            <div className="flex justify-center">
                                                <button onClick={() => setGraphResetCounter(c => c + 1)} className="text-sm text-gray-500 hover:text-red-500 underline">
                                                    Clear Graph
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {question.inputs.map((inp, idx) => (
                                                <div key={idx}>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">{inp.label}</label>
                                                    <input
                                                        type="text"
                                                        className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                        placeholder={inp.isText ? "Answer..." : "e.g. 5 or 8/3"}
                                                        value={userInputs[idx] || ''}
                                                        onChange={(e) => handleInputChange(idx, e.target.value)}
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    <button onClick={checkAnswer} className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-md mt-4">
                                        Submit Answer
                                    </button>
                                </div>
                            )}

                            {showExplanation && (
                                <div className={`mt-6 p-6 rounded-lg border ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                    <div className="flex items-center gap-3 mb-4">
                                        {isCorrect ? <CheckCircle className="text-green-600 w-8 h-8" /> : <XCircle className="text-red-600 w-8 h-8" />}
                                        <h3 className={`text-xl font-bold ${isCorrect ? 'text-green-800' : 'text-red-800'}`}>
                                            {isCorrect ? 'Correct!' : 'Incorrect'}
                                        </h3>
                                    </div>
                                    
                                    <div className="bg-white p-4 rounded border border-gray-200 text-gray-700 leading-relaxed">
                                        <h4 className="font-bold text-gray-900 mb-2 border-b pb-2 flex items-center gap-2">
                                            <PenTool size={16} /> Step-by-Step Solution
                                        </h4>
                                        {question.explanation}
                                    </div>

                                    <div className="mt-6 flex justify-end">
                                        <button onClick={nextQuestion} className="bg-gray-800 text-white py-2 px-6 rounded hover:bg-gray-900 transition flex items-center gap-2">
                                            {currentIdx === QUESTIONS.length - 1 ? 'Finish Test' : 'Next Question'} <ArrowRight size={18} />
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SystemsTest />);
    </script>
</body>
</html>
